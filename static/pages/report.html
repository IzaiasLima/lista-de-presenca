</head>
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frequência Anual</title>
    <link rel="stylesheet" href="../css/style.css">
</head>


<style>
    /* Modal and grid styles for 52-week view */
    #semanasModal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.6);
        z-index: 9999;
    }

    #semanasModal .modal-card {
        background: #fff;
        border-radius: 8px;
        padding: 18px;
        width: min(920px, 96%);
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.4);
    }

    .semanas-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-top: 12px;
    }

    .grid-cell {
        padding: 10px;
        border-radius: 6px;
        text-align: center;
        user-select: none;
        cursor: pointer;
        background: #f3f4f6;
        color: #374151;
        font-weight: 600;
    }

    .grid-cell.present {
        background: #10b981;
        color: white;
    }

    .grid-cell.absent {
        background: #9ca3af;
        color: white;
    }

    .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
    }

    .modal-title {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
    }

    .modal-title h3 {
        margin: 0;
        font-size: 18px;
        color: #111827;
    }

    .small-muted {
        color: #6b7280;
        font-size: 13px;
    }

    .close-x {
        background: transparent;
        border: 0;
        font-size: 20px;
        cursor: pointer;
    }
</style>

<script>
    /*
        Adiciona métodos utilitários para exibir e editar as 52 semanas de um participante
        em uma tabela retangular de 5 colunas.
        - Abre um modal ao dar duplo clique no nome do participante (primeira célula da linha).
        - Sincroniza alterações no modal com a tabela principal.
        Expondo:
        window.tabelaExtra.open52WeeksForParticipant(nomeOuLinha)
        window.tabelaExtra.updateParticipantWeeks(nome, weeksArray)
    */

    function ensureModal() {
        let existing = document.getElementById('semanasModal');
        if (existing) return existing;
        const modal = document.createElement('div');
        modal.id = 'semanasModal';
        modal.style.display = 'block';
        modal.innerHTML = `
        <div class="modal-card" role="dialog" aria-modal="true">
            <div class="modal-title">
                <h3 id="semanasModalTitle">Semanas</h3>
                <button class="close-x" aria-label="Fechar" id="closeSemanasModal">&times;</button>
            </div>
            <div class="small-muted" id="semanasModalSubtitle">Clique para alternar presença/ausência. ★ = semana atual</div>
            <div class="semanas-grid" id="semanasGrid"></div>
            <div class="modal-actions">
                <button class="btn" id="cancelSemanas">Cancelar</button>
                <button class="btn primary" id="saveSemanas">Salvar</button>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
        return modal;
    }

    function readWeeksFromRow(row) {
        // Assume first cell is name — read next cells up to 52
        const cells = Array.from(row.querySelectorAll('td, th'));
        const weekCells = cells.slice(1, 1 + 52);
        const weeks = new Array(52).fill(0);
        for (let i = 0; i < 52; i++) {
            const c = weekCells[i];
            if (!c) { weeks[i] = 0; continue; }
            // heuristics: class 'present' / 'absent', dataset.state, text content (✓)
            if (c.classList.contains('present') || c.dataset.state === '1' || (c.textContent || '').trim().match(/✓|P|Presen/i)) {
                weeks[i] = 1;
            } else {
                weeks[i] = 0;
            }
        }
        return weeks;
    }

    function writeWeeksToRow(row, weeks) {
        const cells = Array.from(row.querySelectorAll('td, th'));
        const weekCells = cells.slice(1, 1 + 52);
        // If there are not enough cells, create remaining cells
        for (let i = 0; i < 52; i++) {
            let c = weekCells[i];
            if (!c) {
                // append td to row
                c = document.createElement('td');
                row.appendChild(c);
            }
            if (weeks[i]) {
                c.classList.add('present');
                c.classList.remove('absent');
                c.dataset.state = '1';
                c.textContent = '✓';
            } else {
                c.classList.add('absent');
                c.classList.remove('present');
                c.dataset.state = '0';
                c.textContent = '';
            }
        }
        // Optionally update totals if your main script uses a function for that.
        if (typeof window.recalcularTotais === 'function') {
            try { window.recalcularTotais(); } catch (e) { /* ignore */ }
        }
    }

    function buildGrid(weeks, currentWeekIndex) {
        const grid = document.createElement('div');
        grid.className = 'semanas-grid';
        for (let i = 0; i < 55; i++) { // 11 rows x 5 cols = 55 to keep rectangle
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            if (i < 52) {
                const weekNum = i + 1;
                cell.dataset.week = i;
                cell.textContent = weekNum;
                if (weeks[i]) cell.classList.add('present');
                else cell.classList.add('absent');
                if (currentWeekIndex === i) {
                    // mark current week visually
                    cell.title = 'Semana atual';
                    cell.textContent = weekNum + ' ★';
                }
            } else {
                cell.style.visibility = 'hidden';
            }
            grid.appendChild(cell);
        }
        return grid;
    }

    function openModalForRow(row) {
        const modal = ensureModal();
        const title = modal.querySelector('#semanasModalTitle');
        const subtitle = modal.querySelector('#semanasModalSubtitle');
        const gridContainer = modal.querySelector('#semanasGrid');
        const closeBtn = modal.querySelector('#closeSemanasModal');
        const saveBtn = modal.querySelector('#saveSemanas');
        const cancelBtn = modal.querySelector('#cancelSemanas');

        const nameCell = row.querySelector('td, th');
        const participantName = nameCell ? (nameCell.textContent || 'Participante') : 'Participante';
        title.textContent = 'Semanas de: ' + participantName.trim();

        // determine current week index if semanaAtual input exists
        let currentWeekIdx = null;
        const semanaInput = document.getElementById('semanaAtual');
        if (semanaInput) {
            const val = parseInt(semanaInput.value);
            if (!isNaN(val) && val >= 1 && val <= 52) currentWeekIdx = val - 1;
        }

        // read current states
        const weeks = readWeeksFromRow(row);

        // populate grid
        gridContainer.innerHTML = '';
        const grid = buildGrid(weeks, currentWeekIdx);
        gridContainer.replaceWith(grid);

        // attach events to new grid cells
        grid.addEventListener('click', function (ev) {
            const cell = ev.target.closest('.grid-cell');
            if (!cell || typeof cell.dataset.week === 'undefined') return;
            const idx = Number(cell.dataset.week);
            if (cell.classList.contains('present')) {
                cell.classList.remove('present');
                cell.classList.add('absent');
            } else {
                cell.classList.remove('absent');
                cell.classList.add('present');
            }
            // live-change optional: you may reflect directly in the table by uncommenting:
            // updateCellInRow(row, idx, cell.classList.contains('present'));
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        closeBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;

        saveBtn.onclick = function () {
            // extract weeks and write back to row
            const newWeeks = [];
            grid.querySelectorAll('.grid-cell').forEach((c, i) => {
                if (i < 52) newWeeks[i] = c.classList.contains('present') ? 1 : 0;
            });
            writeWeeksToRow(row, newWeeks);
            closeModal();
        };

        // show modal
        modal.style.display = 'flex';
    }

    // Exposed API
    window.tabelaExtra = {
        open52WeeksForParticipant: function (identifier) {
            // identifier can be a participant name (string) or a table row element
            if (typeof identifier === 'string') {
                const rows = document.querySelectorAll('#corpoTabela tr');
                for (const r of rows) {
                    const first = r.querySelector('td, th');
                    if (first && (first.textContent || '').trim() === identifier.trim()) {
                        openModalForRow(r);
                        return;
                    }
                }
                console.warn('Participante não encontrado:', identifier);
            } else if (identifier instanceof HTMLElement && identifier.tagName.toLowerCase() === 'tr') {
                openModalForRow(identifier);
            } else {
                console.warn('Parâmetro inválido para open52WeeksForParticipant');
            }
        },
        updateParticipantWeeks: function (nome, weeksArray) {
            // weeksArray: array of 52 items 0/1
            if (!Array.isArray(weeksArray) || weeksArray.length < 52) {
                console.warn('weeksArray deve ser um array com pelo menos 52 elementos.');
                return;
            }
            const rows = document.querySelectorAll('#corpoTabela tr');
            for (const r of rows) {
                const first = r.querySelector('td, th');
                if (first && (first.textContent || '').trim() === nome.trim()) {
                    writeWeeksToRow(r, weeksArray.slice(0, 52));
                    return;
                }
            }
            console.warn('Participante não encontrado para updateParticipantWeeks:', nome);
        }
    };

    // Event delegation: abrir modal ao dar duplo clique no nome (primeira célula) de uma linha
    document.addEventListener('DOMContentLoaded', function () {
        const tbody = document.getElementById('corpoTabela');
        if (!tbody) return;
        tbody.addEventListener('dblclick', function (ev) {
            const cell = ev.target.closest('td, th');
            if (!cell) return;
            const row = cell.closest('tr');
            // only trigger when double-clicking the first cell in the row
            const firstCell = row.querySelector('td, th');
            if (firstCell === cell) {
                openModalForRow(row);
            }
        });

        // optional: add a keyboard shortcut: press "G" while focused on a row to open grid
        document.addEventListener('keydown', function (ev) {
            if (ev.key === 'g' || ev.key === 'G') {
                const sel = document.activeElement;
                const row = sel && sel.closest ? sel.closest('tr') : null;
                if (row && row.closest('#corpoTabela')) openModalForRow(row);
            }
        });
    });

</script>



<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>Frequência Semanal do NCC</h1>
                <img class="login" src="../images/exit.png" onclick="event.preventDefault(); logout();" alt="exit">
            </div>

            <div class="input-group">
                <input type="text" id="novoParticipante" placeholder="Nome do participante"
                    onkeypress="if(event.key==='Enter') adicionarParticipante()">
                <button class="btn primary" onclick="adicionarParticipante()">
                    <span>
                        <img class="login" src="../images/plus.png">
                    </span>
                    <span class="btn-label">
                        Adicionar
                    </span>
                </button>
            </div>

            <div class="navigation">
                <div class="semanas">
                    <div>
                        <label>Semana:</label>
                        <input type="number" id="semanaAtual" min="1" max="52" onchange="atualizarTela()">
                        <span style="color: #6b7280;">&nbsp;de&nbsp;52</span>
                    </div>
                    <div class="btns-semanas">
                        <button class="btn primary" onchange="atualizarTela()">Selecionar Semana</button>
                        <button class="btn primary" onclick="selecionarSemanaAtual()">Exibir Semana Atual</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="tabelaFrequencia">
                    <thead>
                        <tr id="cabecalho"></tr>
                    </thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>

            <div id="estadoVazio" class="empty-state" style="display: none;">
                Adicione participantes para começar o controle de frequência
            </div>
        </div>

        <div class="instructions">
            <h2>Instruções:</h2>
            <ul>
                <li>• Adicione participantes usando o campo acima</li>
                <li>• Clique nas células para marcar presença (verde) ou ausência (cinza)</li>
                <li>• Use "Ir para semana" para navegar pelas 52 semanas</li>
                <li>• Apenas a semana atual (destacada com ★) pode ser editada</li>
                <li>• A linha "Total" mostra a soma de participantes presentes em cada semana</li>
                <li>• Exporte os dados em CSV para usar no Google Sheets</li>
            </ul>
        </div>
    </div>

    <div id="toast">
        <span id="message">
            <!-- Mensagem de notificação -->
        </span>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        // Verifica autenticação antes de executar o script principal
        if (window.auth) {
            window.auth.requireLogin();
        }

          ensureModal();
    </script>
    <script src="../js/main.js"></script>
    <script src="../js/login.js"></script>
    <!-- <script src="../js/table.js"></script> -->
</body>

</html>